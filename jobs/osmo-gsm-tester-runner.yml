## run jobs
- project:
    name: osmo-gsm-testers-runner
    stage:
      - prod
    jobs:
      - 'osmo-gsm-tester_run-{stage}'

# The repo must be used seperate to workaround the bug "Can not expand OSMO_GSM_TESTER_BRANCH".
# The safe-guard check to not use un-defined variables seems to be broken.
- scm:
    name: osmo-gsm-tester-repo
    scm:
      - git:
          url: https://github.com/myriadrf/osmo-gsm-tester
          branches:
            - ${OSMO_GSM_TESTER_BRANCH}
          wipe-workspace: false
          skip-tag: true
          basedir: osmo-gsm-tester

- defaults:
    name: runner
    description: 'Run an actual GSM hardware test using the binaries from the osmo-gsm-tester_build* jobs'
    node: 'osmo-gsm-tester-1'
    project-type: freestyle
    properties:
      - build-discarder:
          num-to-keep: 60
    parameters:
      - string:
          name: "OSMO_GSM_TESTER_BRANCH"
          default: "origin/lc/main"
          description: "Which branch/sha should be used for testing"
      - string:
          name: "OSMO_GSM_TESTER_OPTS"
          default: ""
          description: "pass additional command line options to osmo-gsm-tester.py, e.g. to select specific suites:scenarios. Default: leave empty."
      - string:
          name: "repo"
          default: "osmo-gsm-tester_build-srslte"
          description: "project which build artifacts should be copied from"
      - string:
          name: "OSMO_GSM_TESTER_CONF"
          default: "/home/jenkins/workspace/osmo-gsm-tester_run-prod/osmo-gsm-tester/doc/examples/4g_srsLTE/main.conf"
          description: "Configuration file for osmo-gsm-tester.py"

- job-template:
    name: 'osmo-gsm-tester_run-{stage}'
    defaults: runner
    #node: 'osmo-gsm-tester-{stage}'
    node: 'osmo-gsm-tester-1'
    triggers:
      #- timed: "H 0 * * *"
      - reverse:
            jobs:
                - osmo-gsm-tester_build-srslte
    builders:
      - copyartifact:
          #project: '{repo}'
          project: 'osmo-gsm-tester_build-srslte'
          filter: "*.tgz, *.md5"
          which-build: last-successful
          stable: true
      - shell: !include-raw: osmo-gsm-tester_run-{stage}.sh
    publishers:
      - archive:
          artifacts: '*-run.tgz, *-bin.tgz'
          default-excludes: false
      - junit:
          results: 'trial-*/last_run/trial-*.xml'
          allow-empty-results: true
    scm:
      - 'osmo-gsm-tester-repo'

