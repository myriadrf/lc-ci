# This file holds all gerrit verifications for building deb and rpm packages.
# https://jenkins.osmocom.org/jenkins/view/Jenkins-Gerrit/.
# One can simply add a gerrit job by adding project's repository to repos list.

- project:
    name: gerrit-lint
    # following default values can be overridden by each repo
    disabled: false
    gerrit_url: 'ssh://jenkins@gerrit.osmocom.org:29418'
    repos_url: '{gerrit_url}/{repos}'
    gerrit_project: '{repos}'

    # in alphabetical order
    repos:
      # FIXME: add other repos too
      - osmo-bsc-nat

    jobs:
      - 'gerrit-{repos}-{type}'

    type:
      - 'deb'
      - 'rpm'

- job-template:
    name: 'gerrit-{repos}-{type}'
    project-type: freestyle
    node: osmocom-gerrit-debian11
    disabled: '{obj:disabled}'
    retry-count: 3 # scm checkout
    properties:
      - build-discarder:
          days-to-keep: 30
          num-to-keep: 120
          artifact-days-to-keep: -1
          artifact-num-to-keep: -1
    description: |
      Test building {type} binary packages with patches submitted to gerrit for
      <a href="https://gerrit.osmocom.org/#/q/status:open+project:{repos}">{repos}</a>
      </br></br>
      Related issue: <a href="https://osmocom.org/issues/2385">OS#2385</a>

    parameters:
      - string:
          name: BRANCH_CI
          description: |
                osmo-ci.git branch
          default: 'osmith/wip-ci-packaging'  # FIXME

    scm:
      - git:
         basedir: 'code-from-gerrit'
         url: '{obj:repos_url}'
         credentials-id: d5eda5e9-b59d-44ba-88d2-43473cb6e42d
         branches:
           - $GERRIT_BRANCH
         refspec: $GERRIT_REFSPEC
         name:
         choosing-strategy: gerrit
         wipe-workspace: true
         skip-tag: true
         submodule:
           recursive: false
      - git:
         basedir: 'osmo-ci'
         url: '{gerrit_url}/osmo-ci'
         credentials-id: d5eda5e9-b59d-44ba-88d2-43473cb6e42d
         branches:
           - '$BRANCH_CI'
         wipe-workspace: true

    triggers:
      - gerrit:
          trigger-on:
            - patchset-created-event:
                exclude-drafts: true
                exclude-no-code-change: true
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{obj:gerrit_project}'
              branches:
                - branch-compare-type: 'ANT'
                  branch-pattern: '**'
          skip-vote:
              successful: false
              failed: false
              unstable: false
              notbuilt: false
          silent: false
          escape-quotes: false
          no-name-and-email: false
          trigger-for-unreviewed-patches: true
          server-name: gerrit.osmocom.org

    builders:
      - shell: |-
          # Get distro from type
          case "{type}" in
          deb) distro="debian:11" ;;
          rpm) distro="centos:8" ;;
          *) echo "invalid type '{type}'"; exit 1 ;;
          esac

          # Move code from gerrit to build_srcpkg.py's git cache
          cache_dir=osmo-ci/scripts/obs/_cache
          mkdir -p $cache_dir
          mv code-from-gerrit "$cache_dir/{repos}"

          # Set a known branch name
          git -C "$cache_dir/{repos}" checkout -B "origin/gerrit"

          # Build source package
          cd osmo-ci/scripts/obs/
          ./build_srcpkg.py \
            --docker \
            --feed master \
            --git-branch gerrit \
            --git-skip-fetch \
            "{repos}"

          # Build binary package
          ./build_binpkg.py \
            --docker "$distro" \
            "{repos}"
    wrappers:
    - ansicolor:
        colormap: xterm
    - ssh-agent-credentials:
        users:
        - d5eda5e9-b59d-44ba-88d2-43473cb6e42d

# vim: expandtab tabstop=2 shiftwidth=2
