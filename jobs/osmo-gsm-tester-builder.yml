---
# All job in here builds the binaries
# which will be used by the runner jobs
#
- project:
    name: osmo-gsm-tester-builder

    repo:
      - srslte
    triggered-by: 'master-{repo}'

    jobs:
      - 'osmo-gsm-tester_build-{repo}'

- job-template:
    name: 'osmo-gsm-tester_build-{repo}'
    project-type: freestyle
    node: osmo-gsm-tester-build
    builders:
      - shell: |
          set -e -x
          ./osmo-gsm-tester/contrib/jenkins-build-{repo}.sh
    triggers:
      - reverse:
            jobs: '{triggered-by}'
    publishers:
      - archive:
          artifacts: '*.tgz, *.md5'
          only-if-success: 'true'
          default-excludes: false
    properties:
      - build-discarder:
          num-to-keep: 20
    parameters:
      - string:
          name: "OSMO_GSM_TESTER_BRANCH"
          default: "origin/lc/main"
          description: "Which Osmo-GSM-Tester branch/sha should be used for testing"
      - string:
          name: "trial_binaries"
          default: "srsepc srsenb srsepc_if_masq.sh srsran_install_configs.sh"
          description: "srsRAN Trial binaries to be built, defaults to srsepc srsenb"
      - string:
          name: "src_git_url"
          default: "https://github.com/myriadrf"
          description: "srsRAN Git repository URL, defaults to myriadRF"
      - string:
          name: "configure_opts"
          default: "-DUSE_LTE_RATES=true"
          description: "Build options, default to using LTE rates"
      - string:
          name: "OSMO_GSM_TESTER_BUILD_srsRAN"
          default: "native_lime_22.04"
          description: "srsRAN branch, defaults to native_lime_22.04"
      - string:
          name: "project_name"
          default: "srsRAN"
          description: "Project name override, leave as-is for now"

    scm:
      - osmo-gsm-tester-repo

# The repo must be used seperate to workaround the bug "Can not expand OSMO_GSM_TESTER_BRANCH".
# The safe-guard check to not use un-defined variables seems to be broken.
- scm:
    name: osmo-gsm-tester-repo
    scm:
      - git:
          url: https://github.com/myriadrf/osmo-gsm-tester
          branches:
            - ${OSMO_GSM_TESTER_BRANCH}
          wipe-workspace: false
          skip-tag: true
          basedir: osmo-gsm-tester
